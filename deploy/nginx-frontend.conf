server {
  listen 80;
  server_name _;
  root /usr/share/nginx/html;
  index index.html;
  charset utf-8;

  # Security headers
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Content-Security-Policy "default-src 'self'; img-src 'self' data: blob: https://*.tile.openstreetmap.org https://unpkg.com; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval' https://cdn.jsdelivr.net https://unpkg.com; connect-src 'self' https://koala.osdp25w.xyz https://penguin.osdp25w.xyz wss://koala.osdp25w.xyz; font-src 'self' data:; frame-ancestors 'self'; worker-src 'self' blob:;" always;

  # 不快取入口 HTML，避免舊版入口引到不存在的 chunk
  location = /index.html {
    add_header Cache-Control "no-cache, max-age=0" always;
  }

  # Fernet encryption service removed - using browser-side encryption

  # -------------------------
  # ML dummy endpoints (fallback for legacy bundles)
  # -------------------------
  location = /api/v1/ml/strategy {
    if ($request_method != POST) { return 405; }
    add_header Cache-Control "no-store" always;
    default_type application/json;
    return 200 '{"estTime":32.5,"estEnergy":0.42,"polyline":[]}';
  }
  location = /api/v1/ml/carbon {
    if ($request_method != POST) { return 405; }
    add_header Cache-Control "no-store" always;
    default_type application/json;
    return 200 '{"saved":1.23}';
  }
  location = /api/v1/ml/power {
    if ($request_method != POST) { return 405; }
    add_header Cache-Control "no-store" always;
    default_type application/json;
    return 200 '{"kWh":0.31,"nextCharge":"續航充足"}';
  }

  # -------------------------
  # Vehicles dummy endpoints
  # -------------------------
  location = /api/v1/vehicles/list {
    add_header Cache-Control "no-store" always;
    default_type application/json;
    return 200 '[
      {"id":"DEMO-001","name":"示範車輛-1","batteryPct":85,"batteryLevel":85,"status":"available","siteId":"site-001","lat":23.9917,"lon":121.6014,"mqttStatus":"online","lastSeen":"2025-09-12T00:00:00Z"},
      {"id":"DEMO-002","name":"示範車輛-2","batteryPct":72,"batteryLevel":72,"status":"in-use","siteId":"site-002","lat":23.9750,"lon":121.6060,"mqttStatus":"online","lastSeen":"2025-09-12T00:05:00Z"},
      {"id":"DEMO-003","name":"示範車輛-3","batteryPct":34,"batteryLevel":34,"status":"low-battery","siteId":"site-003","lat":23.9801,"lon":121.6102,"mqttStatus":"offline","lastSeen":"2025-09-11T23:50:00Z"}
    ]';
  }
  location = /api/v1/vehicles {
    add_header Cache-Control "no-store" always;
    default_type application/json;
    return 200 '[
      {"id":"DEMO-001","name":"示範車輛-1","batteryPct":85,"batteryLevel":85,"status":"available","siteId":"site-001","lat":23.9917,"lon":121.6014},
      {"id":"DEMO-002","name":"示範車輛-2","batteryPct":72,"batteryLevel":72,"status":"in-use","siteId":"site-002","lat":23.9750,"lon":121.6060}
    ]';
  }

  # -------------------------
  # Alerts dummy endpoint
  # -------------------------
  location = /api/v1/alerts/open {
    add_header Cache-Control "no-store" always;
    default_type application/json;
    return 200 '[
      {"id":"AL-001","siteId":"site-001","vehicleId":"DEMO-001","type":"battery_temperature","message":"控制器溫度過高 (95°C)","severity":"critical","resolved":false,"createdAt":"2025-09-12T00:00:00Z"},
      {"id":"AL-002","siteId":"site-002","vehicleId":"DEMO-002","type":"temperature_alert","message":"電池溫度偏高 (45°C)","severity":"warning","resolved":false,"createdAt":"2025-09-11T23:50:00Z"}
    ]';
  }

  # API proxy removed - frontend now calls koala.osdp25w.xyz directly

  # Runtime config should never be cached
  location /config/ {
    add_header Cache-Control "no-cache, max-age=0" always;
  }

  # Cache static assets (must come before SPA fallback)
  location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
    add_header Cache-Control "public, max-age=31536000, immutable" always;
  }

  # SPA fallback
  location / {
    # 任何非靜態資源路徑都回傳 index.html
    try_files $uri /index.html;
    # 注意：try_files 對 /index.html 是內部轉址，若不在這個 block 加，
    # 上面的 `location = /index.html` 的 no-store 標頭不會生效。
    # 因此在此也加入禁止快取以避免舊版 index.html 被快取造成白屏。
    add_header Cache-Control "no-cache, max-age=0" always;
  }
}
