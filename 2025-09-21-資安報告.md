# 嘉大數據平台 安全功能說明文件

**文件版本：** v1.0
**最後更新：** 2025-09-21
**系統版本：** Koala Backend v2.0 / Penguin Frontend v1.0

本報告涵蓋系統目前實作的加密、防護與權杖管理機制，並逐一描述涉及的密鑰、流程與工具。

## 安全設計哲學

本系統採用「縱深防禦」(Defense in Depth) 策略：
1. **多層加密**：傳輸層 (TLS) → 應用層 (Fernet) → 儲存層 (資料庫加密)
2. **最小權限原則**：前端僅擁有傳輸加密能力，無法存取實際資料
3. **零信任架構**：不信任任何單一層級，每層都獨立驗證
4. **安全性與可用性平衡**：在保持用戶體驗的前提下實施安全措施

**重要說明：**
- 前端加密是額外防護層，不是主要安全機制
- 真正的安全邊界永遠在後端
- 所有前端驗證都會在後端重新執行

## 1. 核心摘要

| 項目 | 系統後端 | 系統前端 |
|------|---------|---------|
| **核心技術** | Django + cryptography.Fernet + djangorestframework-simplejwt | Vue 3 + Pinia + CryptoJS Fernet 實作 |
| **加密資源** | LOGIN_SECRET_SIGNING_KEY, GENERIC_SECRET_SIGNING_KEY, JWT_SIGNING_KEY | VITE_KOALA_LOGIN_KEY, VITE_KOALA_SENSITIVE_KEY |
| **敏感資料處理** | Model 層與 Serializer 層 Fernet 加密；資料庫僅儲存密文 | 表單送出前 Fernet 加密；API 回應自動批次解密；UI 遮罩顯示 |
| **身分驗證** | JWT (Access 24h / Refresh 7d) | 自動 Token Refresh、401 攔截、Refresh 失敗即登出 |

### 圖一、整體安全架構圖
```
[使用者瀏覽器]
    ↓ (HTTPS/TLS)
[前端應用層加密] - Fernet Transport Encryption
    ↓ (加密資料)
[API Gateway]
    ↓
[後端應用層] - 解密、驗證、重新加密
    ↓
[資料庫層] - 僅儲存加密資料
```

## 2. 系統後端安全架構

### 2.1 密鑰管理

- 以環境變數注入三組核心金鑰：LOGIN_SECRET_SIGNING_KEY、GENERIC_SECRET_SIGNING_KEY、JWT_SIGNING_KEY；未提供時退回 SECRET_KEY。
- **Redis TLS 連線採用環境感知配置：**
  - 開發/測試環境：使用自簽憑證，ssl_cert_reqs='none' 簡化部署流程
  - 生產環境：強制 ssl_cert_reqs='required'，配合 CA Bundle 完整驗證
  - 配置檔會根據環境變數 (ENVIRONMENT) 自動切換驗證模式 (koala/settings.py:204-218)

### 2.2 資料加密層次

**模型層 (utils/encryption/model_fields.py)：**
- @encrypted_fields 裝飾器提供 Fernet getter/setter
- Member 模型的 national_id 於 ORM 寫入/讀出時自動加解密

**Serializer/API 層 (utils/encryption/serializers.py)：**
- EncryptionSerializerMixin 在 to_internal_value 解密輸入
- to_representation 重新加密輸出，避免敏感欄位以明文離開後端

**服務層 (account/services/encryption.py)：**
- LoginEncryptionService → LOGIN_SECRET_SIGNING_KEY，僅處理 password
- MemberEncryptionService → GENERIC_SECRET_SIGNING_KEY，處理 national_id + password
- StaffEncryptionService → GENERIC_SECRET_SIGNING_KEY，處理 password

### 圖二、資料加密層次架構圖
```
[API Request] → [Serializer Layer] → [Service Layer] → [Model Layer] → [Database]
     ↓               ↓                     ↓                ↓              ↓
  加密資料     解密&驗證          業務邏輯處理        重新加密      密文儲存
```

### 2.3 身分驗證與權杖

- account/jwt.py 使用 rest_framework_simplejwt：簽發與刷新 Access/Refresh Token，驗證 Token 時檢查關聯 Profile 是否啟用
- REST Framework 全域預設 JWTAuthentication (koala/settings.py:159-162)
- Access Token 有效 24h、Refresh 7d (SIMPLE_JWT 設定)
- Member 註冊流程 (account/serializers/member.py:149-169) 在 Fernet 解密後使用 Django make_password 進行單向雜湊，確保資料庫無明文密碼

### 圖三、身份驗證與Token生命週期流程圖
```
[登入] → [發行 Token Pair] → [Access Token (24h)] → [自動刷新]
                         ↓                              ↓
                   [Refresh Token (7d)] ← [刷新失敗則登出]
```

## 3. 系統前端頁面安全架構

### 3.1 端到端傳輸加密 (E2EE Transport Encryption)

**設計目的與原則：**
- **目的**：防止網路傳輸過程中的資料洩露（如不安全的 WiFi、代理伺服器記錄）
- **設計原則**：
  - 前端密鑰僅用於傳輸加密，不作為唯一安全防線
  - 後端必須重新驗證、重新加密後才寫入資料庫
  - 即使前端密鑰外洩，攻擊者仍需突破後端驗證與資料庫加密

**實作層級：**
- Layer 1: HTTPS/TLS (基礎傳輸加密)
- Layer 2: Fernet 應用層加密 (額外保護)
- Layer 3: 後端資料庫加密 (最終防線)

**注意：** 前端加密密鑰設計為「可公開但不宜公開」(Public but Obscured)，其安全性不依賴於密鑰的保密性，而是多層防禦架構的一部分。真正的安全邊界在後端。

**技術實作：**
- src/lib/encryption.ts 依情境取用 VITE_KOALA_LOGIN_KEY (登入) 或 VITE_KOALA_SENSITIVE_KEY (註冊/更新 & 身分證)
- encryptPassword / encryptNationalId 送出前確保密鑰存在，否則丟出錯誤阻擋明文
- decryptNationalId、maskNationalId、maskPhone 提供顯示時的解密與遮罩功能

**Fernet 實作細節 (src/lib/fernet_client.ts)：**
- 使用 CryptoJS 實作標準 Fernet 協議
- 32-byte Key 前半用於 HMAC-SHA256 簽章、後半用於 AES-128-CBC 加密
- 手動產生 IV 與實作 PKCS#7 padding
- HMAC 驗證失敗立即拋錯，避免錯誤密鑰導致偽造資料

### 3.2 API 回應處理

**src/lib/api.ts 封裝所有 API 呼叫：**
- 自動附加 Bearer Token
- 回傳 JSON 後透過 decryptSensitiveDeep 遞迴尋找 Fernet token 並以 KOALA_SENSITIVE_KEY 批次解密
- Refresh 流程支援 Koala 多種回應格式，失敗時清空所有 Token 與 Profile

### 3.3 Token 儲存策略與風險緩解

**儲存位置：** localStorage

**設計考量：**
- 需支援跨頁面狀態保持（sessionStorage 無法跨標籤頁）
- 需支援 SPA 路由切換不遺失狀態
- API 為跨域架構，httpOnly Cookie 需額外 CORS 配置複雜度

**風險緩解措施：**
- Token 短效期設計 (Access Token 24小時)
- 實作 CSP (Content Security Policy) 防止 XSS 注入
- 定期 Token 輪替機制
- 敏感操作需重新驗證身份
- 前端程式碼混淆與完整性檢查

**XSS 防護強化：**
- 嚴格 CSP 政策設定
- 所有使用者輸入進行消毒處理
- Vue 框架自動 HTML 轉義
- 異常登入偵測與多重裝置管理

**Token 生命週期管理：**
- src/stores/auth.ts：ensureValidToken 檢查 JWT Expiry（預設 5 分鐘門檻）並在必要時呼叫 refreshTokens()
- 刷新失敗自動登出並清除 localStorage
- src/lib/http-interceptor.ts：全域包裝 fetch，攔截 401 並避免並行 refresh 後重送原始請求

## 4. 密鑰矩陣與格式

| 名稱 | 長度/格式 | 預設來源 | 使用範圍 |
|------|----------|---------|---------|
| LOGIN_SECRET_SIGNING_KEY / VITE_KOALA_LOGIN_KEY | 32-byte Fernet Key (URL-safe Base64) | 環境變數 → .env or Secrets Manager；對應前端變數 | 會員登入密碼加密 (前後端) |
| GENERIC_SECRET_SIGNING_KEY / VITE_KOALA_SENSITIVE_KEY | 同上 | 環境變數 | 會員身分證/敏感欄位；後端模型欄位加密；前端資料顯示解密 |
| JWT_SIGNING_KEY | 任意長度字串 (建議 256-bit 以上) | 環境變數 | JWT Access / Refresh Token 簽章 |

### 密鑰輪替策略（建議）
- 每季進行密鑰輪替評估
- 保留舊密鑰用於解密既有資料
- 新資料一律使用新密鑰加密
- 建立密鑰版本管理機制

## 5. 主要加密流程

### 5.1 登入流程

1. 使用者輸入帳密 → 前端 encryptPassword() 以登入密鑰加密密碼
2. 後端 LoginSerializer (含 LoginEncryptionService) 解密密碼 → 交給 Django 認證系統
3. 驗證成功 → JWTService.create_tokens() 發行 Access/Refresh Token
4. Token 由系統前端儲存於 localStorage，後續 API 透過 http 模組自動附帶

### 圖四、登入流程詳細圖
```
[使用者輸入] → [前端加密] → [API 傳輸] → [後端解密] → [密碼驗證]
                                              ↓
[Token 儲存] ← [前端接收] ← [Token 簽發] ← [驗證成功]
```

### 5.2 會員資料讀寫

**寫入流程：**
1. 使用者在前端頁面編輯表單 → encryptNationalId() 以敏感密鑰加密身份證等欄位
2. Koala 接收後：
   - Serializer to_internal_value 解密明文寫入
   - 模型 @encrypted_fields setter 再次加密後存入資料庫

**讀取流程：**
1. 模型 getter 將資料庫密文解密
2. Serializer to_representation 在返回 JSON 前重新加密
3. 前端頁面收到後再解密呈現或遮罩顯示

### 圖五、敏感資料處理流程圖
```
寫入：[前端加密] → [傳輸] → [後端解密] → [驗證] → [重新加密] → [資料庫]
讀取：[資料庫] → [解密] → [處理] → [重新加密] → [傳輸] → [前端解密/遮罩]
```

### 5.3 Token 自動刷新

1. 每次 API 呼叫由 http-interceptor 確保 Access Token 有效
2. 即將過期時觸發 auth.refreshTokens()，成功則更新儲存與快取；失敗則登出使用者
3. Refresh API 亦回傳使用者 Profile；前端自動同步最新角色與資料

## 6. 相關測試與可驗證資料

| 類型 | 檔案 | 重點 |
|------|------|------|
| 單元測試 | koala/account/tests/test_auth.py 等 | 驗證登入流程會先 Fernet 加密，再登入；錯誤密碼會拒絕 |
| 前端測試頁 | penguin/public/user-edit-test.html | 手動測試身分證、密碼 Fernet 加解密與遮罩 |
| Node 工具 | penguin/test-encrypt.cjs, test-decrypt.cjs | 以 Node Fernet 實作驗證密鑰與密文互通 |
| Cypress 測試 | penguin/cypress/e2e/** | 覆蓋登入、會員管理、敏感欄位編輯等場景 |

## 7. 風險評估與威脅模型

### 防範的攻擊類型
- **中間人攻擊 (MITM)**：透過 TLS + 應用層加密雙重防護
- **SQL 注入**：Django ORM 參數化查詢
- **XSS 攻擊**：CSP 政策 + Vue 自動轉義 + 輸入消毒
- **CSRF 攻擊**：Django CSRF Token + JWT 驗證
- **暴力破解**：密碼複雜度要求 + 登入失敗限制
- **Token 劫持**：短效期 + 自動刷新 + 異常偵測

### 合規性考量
- 符合個人資料保護法要求（敏感資料加密儲存）
- 實作資料最小化原則
- 提供資料遮罩功能保護隱私
- 保留稽核日誌供追蹤

## 8. 緊急應變計畫

### 密鑰洩露處理流程
1. 立即更換所有相關密鑰
2. 強制所有使用者重新登入
3. 檢查系統日誌是否有異常存取
4. 評估影響範圍並通知相關人員

### 資料外洩應變措施
1. 隔離受影響系統
2. 保全證據與日誌
3. 評估洩露資料類型與數量
4. 依法規要求通報主管機關
5. 通知受影響使用者

## 9. 附錄：檔案索引

| 路徑 | 內容概要 |
|------|---------|
| koala/utils/encryption/base.py | BaseEncryptionService：封裝 Fernet 加解密與欄位打包功能 |
| koala/utils/encryption/model_fields.py | @encrypted_fields 模型層裝飾器 |
| koala/account/services/encryption.py | 登入/會員/員工專屬加密服務設定 |
| koala/account/serializers/*.py | 整合 EncryptionSerializerMixin 的序列化器 |
| koala/account/jwt.py | JWT 簽發、刷新、驗證與 Authentication 類別 |
| penguin/src/lib/encryption.ts | 前端敏感欄位加解密與遮罩工具 |
| penguin/src/lib/fernet_client.ts | CryptoJS Fernet 實作 |
| penguin/src/lib/api.ts | HTTP 包裝器 + 自動解密與 Token 管理 |
| penguin/src/stores/auth.ts | Token 刷新與狀態維護 |
| penguin/vite.config.ts | Dev Fernet Endpoint、自動憑證產生 |
| penguin/server/index.js | Express Fernet 加解密服務（測試用途） |

## 10. 詞彙表

- **Fernet**：對稱式加密規範，提供認證加密 (Authenticated Encryption)
- **JWT**：JSON Web Token，用於安全傳輸資訊的開放標準
- **HMAC**：Hash-based Message Authentication Code，雜湊訊息驗證碼
- **CSP**：Content Security Policy，內容安全政策
- **E2EE**：End-to-End Encryption，端到端加密
- **PKCS#7**：Public-Key Cryptography Standards #7，填充標準

---

**文件維護記錄**
- 2025-09-21：初版發布 (v1.0)