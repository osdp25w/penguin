<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Login Test</title>
</head>
<body>
  <h1>登入測試</h1>
  <div>
    <label>Email: <input id="email" value="pony@tourist3.com"></label><br>
    <label>密碼: <input id="password" value="2m8N625cvmf0"></label><br>
    <button onclick="testDirect()">直接測試 (明文)</button>
    <button onclick="testWithToken()">使用 Token 測試</button>
    <button onclick="testViaApp()">透過 App 邏輯測試</button>
  </div>
  <pre id="result"></pre>

  <script type="module">
    window.testDirect = async () => {
      const result = document.getElementById('result');
      try {
        const res = await fetch('/koala/api/account/auth/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
          })
        });
        const data = await res.json();
        result.textContent = `直接測試結果:\n${JSON.stringify(data, null, 2)}`;
      } catch (err) {
        result.textContent = `錯誤: ${err.message}`;
      }
    };

    window.testWithToken = async () => {
      const result = document.getElementById('result');
      const token = 'gAAAAABouquWBZMFmRDZn1Yq2nbF9xfVjy3mKiSXbDqX0BKA5SRCqSr0BO7zO9yajdnq78rr1GWrAdxgSAtpVsKIL1oaaV-16w==';
      try {
        const res = await fetch('/koala/api/account/auth/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: document.getElementById('email').value,
            password: token
          })
        });
        const data = await res.json();
        result.textContent = `Token 測試結果:\n${JSON.stringify(data, null, 2)}`;
      } catch (err) {
        result.textContent = `錯誤: ${err.message}`;
      }
    };

    window.testViaApp = async () => {
      const result = document.getElementById('result');
      try {
        // Import the actual app modules
        const { fernetEncrypt } = await import('/src/lib/fernet.ts');
        const loginKey = import.meta.env.VITE_KOALA_LOGIN_KEY;
        
        result.textContent = `Login Key: ${loginKey ? '已設定' : '未設定'}\n`;
        result.textContent += `Secure Context: ${window.isSecureContext}\n`;
        result.textContent += `WebCrypto Available: ${!!window.crypto?.subtle}\n\n`;
        
        if (loginKey) {
          const password = document.getElementById('password').value;
          try {
            const token = await fernetEncrypt(password, loginKey);
            result.textContent += `加密成功!\nToken: ${token}\n\n`;
            
            // Now try login
            const res = await fetch('/koala/api/account/auth/login/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                email: document.getElementById('email').value,
                password: token
              })
            });
            const data = await res.json();
            result.textContent += `登入結果:\n${JSON.stringify(data, null, 2)}`;
          } catch (encErr) {
            result.textContent += `加密錯誤: ${encErr.message}\n${encErr.stack}`;
          }
        }
      } catch (err) {
        result.textContent = `模組載入錯誤: ${err.message}`;
      }
    };
  </script>
</body>
</html>