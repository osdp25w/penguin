<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç›´æ¥ API æ¸¬è©¦</title>
  <style>
    body { font-family: system-ui; padding: 20px; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .result { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .step { margin: 10px 0; padding: 10px; border-left: 3px solid #007bff; background: #f8f9fa; }
  </style>
</head>
<body>
  <h1>ğŸ” ç›´æ¥ API æ¸¬è©¦</h1>
  <p>ç›´æ¥ä½¿ç”¨ fetch èª¿ç”¨ APIï¼Œä¸ä¾è³´ä»»ä½•æ¡†æ¶</p>
  <button id="testBtn">é–‹å§‹ API æ¸¬è©¦</button>
  <div id="result" class="result"></div>

  <script>
    document.getElementById('testBtn').addEventListener('click', async () => {
      const result = document.getElementById('result');
      result.innerHTML = '<div class="info">ğŸ”„ é–‹å§‹ API æ¸¬è©¦æµç¨‹...</div>';
      
      try {
        let html = '';
        
        // æ­¥é©Ÿ 1: åŠ å¯†å¯†ç¢¼
        html += '<div class="step"><strong>æ­¥é©Ÿ 1:</strong> åŠ å¯†å¯†ç¢¼</div>';
        result.innerHTML = html;
        
        const encryptRes = await fetch('/local/fernet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: '2m8N625cvmf0' })
        });
        
        if (!encryptRes.ok) {
          throw new Error('å¯†ç¢¼åŠ å¯†å¤±æ•—: ' + encryptRes.status);
        }
        
        const encryptData = await encryptRes.json();
        const encryptedPassword = encryptData.token;
        console.log('åŠ å¯†å¾Œå¯†ç¢¼:', encryptedPassword);
        
        // æ­¥é©Ÿ 2: ç™»å…¥
        html += '<div class="step"><strong>æ­¥é©Ÿ 2:</strong> ç™»å…¥ç²å– Token</div>';
        result.innerHTML = html;
        
        const loginRes = await fetch('/koala/api/account/auth/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'pony_member_real1',
            password: encryptedPassword
          })
        });
        
        if (!loginRes.ok) {
          throw new Error('ç™»å…¥å¤±æ•—: ' + loginRes.status);
        }
        
        const loginData = await loginRes.json();
        console.log('ç™»å…¥å›æ‡‰:', loginData);
        
        if (loginData.code !== 2000) {
          throw new Error('ç™»å…¥å¤±æ•—: ' + loginData.msg);
        }
        
        const token = loginData.data.tokens.access_token;
        const profile = loginData.data.profile;
        
        // æ­¥é©Ÿ 3: æª¢æŸ¥ç™»å…¥å›æ‡‰ä¸­çš„ profile
        html += '<div class="step"><strong>æ­¥é©Ÿ 3:</strong> æª¢æŸ¥ç™»å…¥å›æ‡‰ä¸­çš„ profile</div>';
        result.innerHTML = html;
        
        console.log('ç™»å…¥ profile:', profile);
        console.log('ç™»å…¥ profile phone:', profile?.phone);
        console.log('ç™»å…¥ profile national_id:', profile?.national_id);
        
        // æ­¥é©Ÿ 4: èª¿ç”¨ Member API
        html += '<div class="step"><strong>æ­¥é©Ÿ 4:</strong> èª¿ç”¨ Member API</div>';
        result.innerHTML = html;
        
        const memberId = profile?.id || profile?.user_id || '1';
        console.log('ä½¿ç”¨ Member ID:', memberId);
        
        const memberRes = await fetch('/koala/api/account/members/' + memberId + '/', {
          method: 'GET',
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json' 
          }
        });
        
        if (!memberRes.ok) {
          throw new Error('Member API èª¿ç”¨å¤±æ•—: ' + memberRes.status);
        }
        
        const memberData = await memberRes.json();
        console.log('Member API å®Œæ•´å›æ‡‰:', memberData);
        
        const memberInfo = memberData.data || memberData;
        console.log('Member è³‡æ–™:', memberInfo);
        console.log('Member phone:', memberInfo?.phone);
        console.log('Member national_id:', memberInfo?.national_id);
        
        // é¡¯ç¤ºçµæœ
        html += '<div class="success"><h3>âœ… API æ¸¬è©¦å®Œæˆ</h3></div>';
        
        // ç™»å…¥ Profile åˆ†æ
        html += '<h4>ğŸ” ç™»å…¥å›æ‡‰ Profile æª¢æŸ¥ï¼š</h4>';
        html += '<ul>';
        html += '<li><strong>id:</strong> ' + (profile?.id || profile?.user_id || 'âŒ ç„¡') + '</li>';
        html += '<li><strong>username:</strong> ' + (profile?.username || 'âŒ ç„¡') + '</li>';
        html += '<li><strong>full_name:</strong> ' + (profile?.full_name || 'âŒ ç„¡') + '</li>';
        html += '<li><strong>email:</strong> ' + (profile?.email || 'âŒ ç„¡') + '</li>';
        html += '<li><strong>phone:</strong> ' + (profile?.phone || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>national_id:</strong> ' + (profile?.national_id || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>type:</strong> ' + (profile?.type || 'âŒ ç„¡') + '</li>';
        html += '</ul>';
        
        // Member API åˆ†æ
        html += '<h4>ğŸ” Member API å›æ‡‰æª¢æŸ¥ï¼š</h4>';
        html += '<ul>';
        html += '<li><strong>phone:</strong> ' + (memberInfo?.phone || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>national_id:</strong> ' + (memberInfo?.national_id || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>full_name:</strong> ' + (memberInfo?.full_name || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>email:</strong> ' + (memberInfo?.email || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>username:</strong> ' + (memberInfo?.username || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>type:</strong> ' + (memberInfo?.type || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '</ul>';
        
        // å•é¡Œè¨ºæ–·
        html += '<h4>ğŸ©º å•é¡Œè¨ºæ–·ï¼š</h4>';
        const loginHasPhone = profile?.phone;
        const loginHasNationalId = profile?.national_id;
        const apiHasPhone = memberInfo?.phone;
        const apiHasNationalId = memberInfo?.national_id;
        
        html += '<ul>';
        if (!loginHasPhone && !apiHasPhone) {
          html += '<li>âŒ <strong>phone å•é¡Œ:</strong> ç™»å…¥å›æ‡‰å’Œ Member API éƒ½æ²’æœ‰ phone æ¬„ä½</li>';
        } else if (loginHasPhone && !apiHasPhone) {
          html += '<li>âš ï¸ <strong>phone å•é¡Œ:</strong> ç™»å…¥æœ‰ phoneï¼Œä½† Member API æ²’æœ‰</li>';
        } else if (!loginHasPhone && apiHasPhone) {
          html += '<li>âš ï¸ <strong>phone å•é¡Œ:</strong> ç™»å…¥æ²’æœ‰ phoneï¼Œä½† Member API æœ‰</li>';
        } else {
          html += '<li>âœ… <strong>phone æ­£å¸¸:</strong> å…©å€‹ API éƒ½æœ‰ phone æ¬„ä½</li>';
        }
        
        if (!loginHasNationalId && !apiHasNationalId) {
          html += '<li>âŒ <strong>national_id å•é¡Œ:</strong> ç™»å…¥å›æ‡‰å’Œ Member API éƒ½æ²’æœ‰ national_id æ¬„ä½</li>';
        } else if (loginHasNationalId && !apiHasNationalId) {
          html += '<li>âš ï¸ <strong>national_id å•é¡Œ:</strong> ç™»å…¥æœ‰ national_idï¼Œä½† Member API æ²’æœ‰</li>';
        } else if (!loginHasNationalId && apiHasNationalId) {
          html += '<li>âš ï¸ <strong>national_id å•é¡Œ:</strong> ç™»å…¥æ²’æœ‰ national_idï¼Œä½† Member API æœ‰</li>';
        } else {
          html += '<li>âœ… <strong>national_id æ­£å¸¸:</strong> å…©å€‹ API éƒ½æœ‰ national_id æ¬„ä½</li>';
        }
        html += '</ul>';
        
        // å»ºè­°
        html += '<h4>ğŸ’¡ å»ºè­°è§£æ±ºæ–¹æ¡ˆï¼š</h4>';
        html += '<ul>';
        if (!loginHasPhone && !apiHasPhone) {
          html += '<li>æª¢æŸ¥å¾Œç«¯è³‡æ–™åº«ä¸­æ˜¯å¦æœ‰å„²å­˜ phone è³‡æ–™</li>';
          html += '<li>æª¢æŸ¥å¾Œç«¯ API åºåˆ—åŒ–å™¨æ˜¯å¦åŒ…å« phone æ¬„ä½</li>';
        }
        if (!loginHasNationalId && !apiHasNationalId) {
          html += '<li>æª¢æŸ¥å¾Œç«¯è³‡æ–™åº«ä¸­æ˜¯å¦æœ‰å„²å­˜ national_id è³‡æ–™</li>';
          html += '<li>æª¢æŸ¥å¾Œç«¯ API åºåˆ—åŒ–å™¨æ˜¯å¦åŒ…å« national_id æ¬„ä½</li>';
        }
        if ((loginHasPhone || apiHasPhone) && (loginHasNationalId || apiHasNationalId)) {
          html += '<li>æª¢æŸ¥å‰ç«¯ auth store çš„è³‡æ–™è™•ç†é‚è¼¯</li>';
          html += '<li>æª¢æŸ¥å€‹äººè³‡æ–™æ¨¡æ…‹æ¡†çš„è³‡æ–™ç¶å®š</li>';
        }
        html += '</ul>';
        
        // é¡¯ç¤ºå®Œæ•´å›æ‡‰
        html += '<details style="margin-top: 20px;"><summary><h4>ğŸ“„ å®Œæ•´ç™»å…¥å›æ‡‰</h4></summary>';
        html += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto; max-height: 300px;">';
        html += JSON.stringify(loginData, null, 2);
        html += '</pre></details>';
        
        html += '<details><summary><h4>ğŸ“„ å®Œæ•´ Member API å›æ‡‰</h4></summary>';
        html += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto; max-height: 300px;">';
        html += JSON.stringify(memberData, null, 2);
        html += '</pre></details>';
        
        result.innerHTML = html;
        
      } catch (err) {
        console.error('API æ¸¬è©¦éŒ¯èª¤:', err);
        result.innerHTML += '<div class="error"><h3>âŒ API æ¸¬è©¦å¤±æ•—</h3><p>' + err.message + '</p></div>';
      }
    });
  </script>
</body>
</html>