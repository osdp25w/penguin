<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Token API æ¸¬è©¦</title>
  <style>
    body { font-family: system-ui; padding: 20px; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .result { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .warning { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <h1>ä½¿ç”¨ç¾æœ‰ Token æ¸¬è©¦ Member API</h1>
  <p>è«‹å…ˆåœ¨ä¸»æ‡‰ç”¨ä¸­ç™»å…¥ pony_member_real1ï¼Œç„¶å¾Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•</p>
  <button id="testBtn">ä½¿ç”¨ç¾æœ‰ Token æ¸¬è©¦ Member API</button>
  <div id="result" class="result"></div>

  <script>
    document.getElementById('testBtn').addEventListener('click', async () => {
      const result = document.getElementById('result');
      result.innerHTML = 'æ­£åœ¨æª¢æŸ¥...';
      
      try {
        // æª¢æŸ¥æ˜¯å¦æœ‰ token
        const token = localStorage.getItem('penguin.jwt');
        if (!token) {
          result.innerHTML = '<div class="warning"><h3>âš ï¸ æ‰¾ä¸åˆ° Token</h3><p>è«‹å…ˆåœ¨ä¸»æ‡‰ç”¨ä¸­ç™»å…¥ pony_member_real1</p></div>';
          return;
        }
        
        console.log('ä½¿ç”¨ token:', token.substring(0, 20) + '...');
        
        // èª¿ç”¨ Member API
        console.log('å‘¼å« Member API...');
        const memberRes = await fetch('/koala/api/account/members/1/', {
          method: 'GET',
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json' 
          }
        });
        
        console.log('Member API ç‹€æ…‹:', memberRes.status);
        
        if (!memberRes.ok) {
          const errorText = await memberRes.text();
          throw new Error('API èª¿ç”¨å¤±æ•—: ' + memberRes.status + ' - ' + errorText);
        }
        
        const memberData = await memberRes.json();
        console.log('Member API å®Œæ•´å›æ‡‰:', memberData);
        
        const data = memberData.data || memberData;
        console.log('å¯¦éš›è³‡æ–™:', data);
        console.log('phone:', data?.phone);
        console.log('national_id:', data?.national_id);
        console.log('full_name:', data?.full_name);
        
        // é¡¯ç¤ºçµæœ
        let html = '<div class="success"><h3>âœ… Member API æ¸¬è©¦æˆåŠŸ</h3></div>';
        html += '<h4>é—œéµæ¬„ä½æª¢æŸ¥çµæœï¼š</h4>';
        html += '<ul>';
        html += '<li><strong>phone:</strong> ' + (data?.phone || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>national_id:</strong> ' + (data?.national_id || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>full_name:</strong> ' + (data?.full_name || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>email:</strong> ' + (data?.email || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>username:</strong> ' + (data?.username || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>type:</strong> ' + (data?.type || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '</ul>';
        
        // æª¢æŸ¥æ˜¯å¦æœ‰èº«ä»½è­‰è™Ÿä¸”åŠ å¯†
        if (data?.national_id) {
          html += '<h4>ğŸ” èº«ä»½è­‰è™Ÿåˆ†æï¼š</h4>';
          html += '<ul>';
          html += '<li><strong>åŸå§‹å€¼:</strong> ' + data.national_id + '</li>';
          html += '<li><strong>æ˜¯å¦åŠ å¯†:</strong> ' + (data.national_id.startsWith('gAAAAA') ? 'âœ… æ˜¯ï¼ˆFernet åŠ å¯†ï¼‰' : 'âŒ å¦ï¼ˆæ˜æ–‡ï¼‰') + '</li>';
          if (data.national_id.length > 20) {
            html += '<li><strong>é•·åº¦:</strong> ' + data.national_id.length + ' å­—å…ƒï¼ˆçœ‹èµ·ä¾†åƒåŠ å¯†è³‡æ–™ï¼‰</li>';
          }
          html += '</ul>';
        }
        
        html += '<h4>å®Œæ•´ API å›æ‡‰ï¼š</h4>';
        html += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto; max-height: 300px;">';
        html += JSON.stringify(memberData, null, 2);
        html += '</pre>';
        
        result.innerHTML = html;
        
      } catch (err) {
        console.error('API æ¸¬è©¦éŒ¯èª¤:', err);
        result.innerHTML = '<div class="error"><h3>âŒ API æ¸¬è©¦å¤±æ•—</h3><p>' + err.message + '</p></div>';
      }
    });
  </script>
</body>
</html>