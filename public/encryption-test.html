<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>加解密測試</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 800px; margin: 0 auto; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .code { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; font-family: monospace; word-break: break-all; }
  </style>
</head>
<body>
  <h1>🔐 加解密測試</h1>
  
  <div>
    <button onclick="testEncryption()">測試加解密功能</button>
    <button onclick="testDecryptSample()">測試解密範例資料</button>
    <button onclick="clearResults()">清除結果</button>
  </div>

  <div id="result"></div>

  <script type="module">
    const result = document.getElementById('result');
    
    // 測試基本加解密功能
    window.testEncryption = async () => {
      try {
        result.innerHTML = '<div class="info">🔄 正在測試加解密功能...</div>';
        
        const testData = 'A123456789'; // 測試身份證號
        const sensitiveKey = '***REMOVED***';
        
        console.log('Testing encryption/decryption with:', testData);
        console.log('Using key:', sensitiveKey);
        
        // 測試加密
        const encryptResponse = await fetch('/local/fernet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: testData,
            key: sensitiveKey
          })
        });
        
        if (!encryptResponse.ok) {
          throw new Error(`Encrypt failed: ${encryptResponse.status}`);
        }
        
        const encryptData = await encryptResponse.json();
        console.log('Encrypted token:', encryptData.token);
        
        // 測試解密
        const decryptResponse = await fetch('/local/fernet/decrypt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            tokens: [encryptData.token],
            key: sensitiveKey
          })
        });
        
        if (!decryptResponse.ok) {
          throw new Error(`Decrypt failed: ${decryptResponse.status}`);
        }
        
        const decryptData = await decryptResponse.json();
        const decrypted = decryptData.values[0];
        
        console.log('Decrypted value:', decrypted);
        
        let html = '<div class="success">✅ 加解密測試成功！</div>';
        html += '<h3>測試結果：</h3>';
        html += `<p><strong>原始資料：</strong><span class="code">${testData}</span></p>`;
        html += `<p><strong>加密後：</strong><span class="code">${encryptData.token}</span></p>`;
        html += `<p><strong>解密後：</strong><span class="code">${decrypted}</span></p>`;
        html += `<p><strong>是否一致：</strong>${testData === decrypted ? '✅ 是' : '❌ 否'}</p>`;
        
        result.innerHTML = html;
        
      } catch (err) {
        result.innerHTML = `<div class="error">❌ 加解密測試失敗：${err.message}</div>`;
        console.error('Encryption test error:', err);
      }
    };
    
    // 測試解密一個實際的加密範例
    window.testDecryptSample = async () => {
      try {
        result.innerHTML = '<div class="info">🔄 正在測試解密範例資料...</div>';
        
        // 這是一個實際從 API 可能收到的加密身份證號範例
        const encryptedSample = 'gAAAAABmZ8QX7Y3VUa8hF4oJOWV2pMxnZs9k_QF3R7tA-8JvBnKmOpQ-2sUzWxY4f6LcMdE9_3nVnJhK2aRvPwKq8vXmN6LqGg==';
        const sensitiveKey = '***REMOVED***';
        
        console.log('Testing decryption with sample:', encryptedSample);
        
        // 使用加密模組測試
        const { decryptNationalId } = await import('/src/lib/encryption.ts');
        const decrypted = await decryptNationalId(encryptedSample);
        
        let html = '<div class="success">✅ 範例解密測試完成！</div>';
        html += '<h3>測試結果：</h3>';
        html += `<p><strong>加密資料：</strong><span class="code">${encryptedSample}</span></p>`;
        html += `<p><strong>解密結果：</strong><span class="code">${decrypted}</span></p>`;
        
        // 如果解密成功且看起來像身份證號，顯示打碼版本
        if (decrypted && decrypted !== encryptedSample && /^[A-Z]\d{9}$/.test(decrypted)) {
          const { maskNationalId } = await import('/src/lib/encryption.ts');
          const masked = maskNationalId(decrypted);
          html += `<p><strong>打碼顯示：</strong><span class="code">${masked}</span></p>`;
        }
        
        result.innerHTML = html;
        
      } catch (err) {
        result.innerHTML = `<div class="error">❌ 範例解密測試失敗：${err.message}</div>`;
        console.error('Sample decryption test error:', err);
      }
    };
    
    window.clearResults = () => {
      result.innerHTML = '';
    };
  </script>
</body>
</html>