<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>åŠ è§£å¯†æ¸¬è©¦</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 800px; margin: 0 auto; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .code { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; font-family: monospace; word-break: break-all; }
  </style>
</head>
<body>
  <h1>ğŸ” åŠ è§£å¯†æ¸¬è©¦</h1>
  
  <div>
    <button onclick="testEncryption()">æ¸¬è©¦åŠ è§£å¯†åŠŸèƒ½</button>
    <button onclick="testDecryptSample()">æ¸¬è©¦è§£å¯†ç¯„ä¾‹è³‡æ–™</button>
    <button onclick="clearResults()">æ¸…é™¤çµæœ</button>
  </div>

  <div id="result"></div>

  <script type="module">
    const result = document.getElementById('result');
    
    // æ¸¬è©¦åŸºæœ¬åŠ è§£å¯†åŠŸèƒ½
    window.testEncryption = async () => {
      try {
        result.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨æ¸¬è©¦åŠ è§£å¯†åŠŸèƒ½...</div>';
        
        const testData = 'A123456789'; // æ¸¬è©¦èº«ä»½è­‰è™Ÿ
        const sensitiveKey = '***REMOVED***';
        
        console.log('Testing encryption/decryption with:', testData);
        console.log('Using key:', sensitiveKey);
        
        // æ¸¬è©¦åŠ å¯†
        const encryptResponse = await fetch('/local/fernet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: testData,
            key: sensitiveKey
          })
        });
        
        if (!encryptResponse.ok) {
          throw new Error(`Encrypt failed: ${encryptResponse.status}`);
        }
        
        const encryptData = await encryptResponse.json();
        console.log('Encrypted token:', encryptData.token);
        
        // æ¸¬è©¦è§£å¯†
        const decryptResponse = await fetch('/local/fernet/decrypt', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            tokens: [encryptData.token],
            key: sensitiveKey
          })
        });
        
        if (!decryptResponse.ok) {
          throw new Error(`Decrypt failed: ${decryptResponse.status}`);
        }
        
        const decryptData = await decryptResponse.json();
        const decrypted = decryptData.values[0];
        
        console.log('Decrypted value:', decrypted);
        
        let html = '<div class="success">âœ… åŠ è§£å¯†æ¸¬è©¦æˆåŠŸï¼</div>';
        html += '<h3>æ¸¬è©¦çµæœï¼š</h3>';
        html += `<p><strong>åŸå§‹è³‡æ–™ï¼š</strong><span class="code">${testData}</span></p>`;
        html += `<p><strong>åŠ å¯†å¾Œï¼š</strong><span class="code">${encryptData.token}</span></p>`;
        html += `<p><strong>è§£å¯†å¾Œï¼š</strong><span class="code">${decrypted}</span></p>`;
        html += `<p><strong>æ˜¯å¦ä¸€è‡´ï¼š</strong>${testData === decrypted ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>`;
        
        result.innerHTML = html;
        
      } catch (err) {
        result.innerHTML = `<div class="error">âŒ åŠ è§£å¯†æ¸¬è©¦å¤±æ•—ï¼š${err.message}</div>`;
        console.error('Encryption test error:', err);
      }
    };
    
    // æ¸¬è©¦è§£å¯†ä¸€å€‹å¯¦éš›çš„åŠ å¯†ç¯„ä¾‹
    window.testDecryptSample = async () => {
      try {
        result.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨æ¸¬è©¦è§£å¯†ç¯„ä¾‹è³‡æ–™...</div>';
        
        // é€™æ˜¯ä¸€å€‹å¯¦éš›å¾ API å¯èƒ½æ”¶åˆ°çš„åŠ å¯†èº«ä»½è­‰è™Ÿç¯„ä¾‹
        const encryptedSample = 'gAAAAABmZ8QX7Y3VUa8hF4oJOWV2pMxnZs9k_QF3R7tA-8JvBnKmOpQ-2sUzWxY4f6LcMdE9_3nVnJhK2aRvPwKq8vXmN6LqGg==';
        const sensitiveKey = '***REMOVED***';
        
        console.log('Testing decryption with sample:', encryptedSample);
        
        // ä½¿ç”¨åŠ å¯†æ¨¡çµ„æ¸¬è©¦
        const { decryptNationalId } = await import('/src/lib/encryption.ts');
        const decrypted = await decryptNationalId(encryptedSample);
        
        let html = '<div class="success">âœ… ç¯„ä¾‹è§£å¯†æ¸¬è©¦å®Œæˆï¼</div>';
        html += '<h3>æ¸¬è©¦çµæœï¼š</h3>';
        html += `<p><strong>åŠ å¯†è³‡æ–™ï¼š</strong><span class="code">${encryptedSample}</span></p>`;
        html += `<p><strong>è§£å¯†çµæœï¼š</strong><span class="code">${decrypted}</span></p>`;
        
        // å¦‚æœè§£å¯†æˆåŠŸä¸”çœ‹èµ·ä¾†åƒèº«ä»½è­‰è™Ÿï¼Œé¡¯ç¤ºæ‰“ç¢¼ç‰ˆæœ¬
        if (decrypted && decrypted !== encryptedSample && /^[A-Z]\d{9}$/.test(decrypted)) {
          const { maskNationalId } = await import('/src/lib/encryption.ts');
          const masked = maskNationalId(decrypted);
          html += `<p><strong>æ‰“ç¢¼é¡¯ç¤ºï¼š</strong><span class="code">${masked}</span></p>`;
        }
        
        result.innerHTML = html;
        
      } catch (err) {
        result.innerHTML = `<div class="error">âŒ ç¯„ä¾‹è§£å¯†æ¸¬è©¦å¤±æ•—ï¼š${err.message}</div>`;
        console.error('Sample decryption test error:', err);
      }
    };
    
    window.clearResults = () => {
      result.innerHTML = '';
    };
  </script>
</body>
</html>