<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>個人資料測試</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 1000px; margin: 0 auto; }
    .test-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .warning { background: #fff3cd; color: #856404; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .user-info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .test-form { background: white; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6; margin: 20px 0; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>🔧 個人資料修改測試</h1>
  
  <div class="test-section">
    <h3>📋 測試說明</h3>
    <p>測試不同角色的個人資料修改功能：</p>
    <ol>
      <li>Admin 帳號（pony@admin1.com）- 使用 staff API</li>
      <li>Member 帳號（pony_member_real1）- 使用 members API</li>
      <li>檢查 updateMe 功能是否正常運作</li>
    </ol>
  </div>

  <div>
    <button onclick="testAdminProfile()">測試 Admin 個人資料</button>
    <button onclick="testMemberProfile()">測試 Member 個人資料</button>
    <button onclick="clearAll()">清除測試</button>
  </div>

  <div id="result"></div>
  <div id="userInfo"></div>
  <div id="testForm"></div>

  <script type="module">
    const result = document.getElementById('result');
    const userInfo = document.getElementById('userInfo');
    const testForm = document.getElementById('testForm');
    
    let authStore = null;
    
    // 測試 Admin 個人資料功能
    window.testAdminProfile = async () => {
      try {
        // 清理
        localStorage.clear();
        sessionStorage.clear();
        result.innerHTML = '<div class="info">🔄 正在測試 Admin 個人資料功能...</div>';
        userInfo.innerHTML = '';
        testForm.innerHTML = '';
        
        // 登入 Admin
        const { useAuth } = await import('/src/stores/auth.ts');
        authStore = useAuth();
        
        console.log('登入 pony@admin1.com...');
        await authStore.login('pony@admin1.com', '2m8N625cvmf0');
        
        // 顯示用戶資料
        displayUserInfo(authStore.user);
        
        // 創建測試表單
        createTestForm();
        
        result.innerHTML = '<div class="success">✅ Admin 登入成功！可以開始測試個人資料修改</div>';
        
      } catch (err) {
        result.innerHTML = \`<div class="error">❌ Admin 測試失敗：\${err.message}</div>\`;
        console.error('Admin profile test error:', err);
      }
    };
    
    // 測試 Member 個人資料功能
    window.testMemberProfile = async () => {
      try {
        // 清理
        localStorage.clear();
        sessionStorage.clear();
        result.innerHTML = '<div class="info">🔄 正在測試 Member 個人資料功能...</div>';
        userInfo.innerHTML = '';
        testForm.innerHTML = '';
        
        // 登入 Member
        const { useAuth } = await import('/src/stores/auth.ts');
        authStore = useAuth();
        
        console.log('登入 pony_member_real1...');
        await authStore.login('pony_member_real1', '2m8N625cvmf0');
        
        // 顯示用戶資料
        displayUserInfo(authStore.user);
        
        // 創建測試表單
        createTestForm();
        
        result.innerHTML = '<div class="success">✅ Member 登入成功！可以開始測試個人資料修改</div>';
        
      } catch (err) {
        result.innerHTML = \`<div class="error">❌ Member 測試失敗：\${err.message}</div>\`;
        console.error('Member profile test error:', err);
      }
    };
    
    // 顯示用戶資料
    function displayUserInfo(user) {
      if (!user) {
        userInfo.innerHTML = '<div class="warning">⚠️ 沒有用戶資料</div>';
        return;
      }
      
      let html = '<div class="user-info">';
      html += '<h4>📋 目前用戶資料</h4>';
      html += \`<p><strong>ID：</strong>\${user.id || '無'}</p>\`;
      html += \`<p><strong>姓名：</strong>\${user.name || '無'}</p>\`;
      html += \`<p><strong>Email：</strong>\${user.email || '無'}</p>\`;
      html += \`<p><strong>角色：</strong>\${user.roleId || '無'}</p>\`;
      html += \`<p><strong>手機：</strong>\${user.phone || '無'}</p>\`;
      html += \`<p><strong>身份證：</strong>\${user.idNumber || '無'}</p>\`;
      html += \`<p><strong>頭像：</strong>\${user.avatarUrl || '無'}</p>\`;
      html += '</div>';
      
      userInfo.innerHTML = html;
    }
    
    // 創建測試表單
    function createTestForm() {
      let html = '<div class="test-form">';
      html += '<h4>🧪 個人資料修改測試</h4>';
      html += '<div class="form-group">';
      html += '<label>姓名：</label>';
      html += \`<input type="text" id="testName" value="\${authStore?.user?.name || ''}" />\`;
      html += '</div>';
      html += '<div class="form-group">';
      html += '<label>電話：</label>';
      html += \`<input type="tel" id="testPhone" value="\${authStore?.user?.phone || ''}" />\`;
      html += '</div>';
      html += '<div class="form-group">';
      html += '<label>Email：</label>';
      html += \`<input type="email" id="testEmail" value="\${authStore?.user?.email || ''}" />\`;
      html += '</div>';
      html += '<div class="form-group">';
      html += '<label>身份證號：</label>';
      html += \`<input type="text" id="testIdNumber" value="\${authStore?.user?.idNumber || ''}" maxlength="10" placeholder="A123456789" />\`;
      html += '</div>';
      html += '<div class="form-group">';
      html += '<button onclick="testUpdateProfile()">🔄 測試更新個人資料</button>';
      html += '</div>';
      html += '</div>';
      
      testForm.innerHTML = html;
    }
    
    // 測試更新個人資料
    window.testUpdateProfile = async () => {
      if (!authStore) {
        result.innerHTML = '<div class="error">❌ 請先登入</div>';
        return;
      }
      
      try {
        const name = document.getElementById('testName').value;
        const phone = document.getElementById('testPhone').value;
        const email = document.getElementById('testEmail').value;
        const idNumber = document.getElementById('testIdNumber').value;
        
        result.innerHTML = '<div class="info">🔄 正在更新個人資料...</div>';
        
        const payload = {
          name: name,
          phone: phone,
          email: email,
          idNumber: idNumber || undefined
        };
        
        console.log('Updating profile with payload:', payload);
        
        // 呼叫 updateMe
        const updatedUser = await authStore.updateMe(payload);
        
        console.log('Updated user:', updatedUser);
        
        // 重新顯示用戶資料
        displayUserInfo(updatedUser);
        
        result.innerHTML = '<div class="success">✅ 個人資料更新成功！</div>';
        
      } catch (err) {
        result.innerHTML = \`<div class="error">❌ 個人資料更新失敗：\${err.message}</div>\`;
        console.error('Profile update error:', err);
      }
    };
    
    window.clearAll = () => {
      localStorage.clear();
      sessionStorage.clear();
      result.innerHTML = '';
      userInfo.innerHTML = '';
      testForm.innerHTML = '';
      authStore = null;
    };
  </script>
</body>
</html>