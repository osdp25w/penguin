<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>個人資料除錯</title>
  <style>
    body { font-family: system-ui; padding: 20px; max-width: 1000px; margin: 0 auto; }
    .test-section { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
    .success { background: #d4edda; color: #155724; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .error { background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .info { background: #d1ecf1; color: #0c5460; padding: 15px; border-radius: 5px; margin: 10px 0; }
    .code-block { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; padding: 15px; font-family: monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
    .data-section { margin: 20px 0; }
  </style>
</head>
<body>
  <h1>🐛 個人資料除錯工具</h1>
  
  <div class="test-section">
    <h3>📋 檢查流程</h3>
    <ol>
      <li>登入並檢查 API 回應結構</li>
      <li>檢查 localStorage 中保存的 profile</li>
      <li>檢查 auth store 中的用戶資料</li>
      <li>分析缺失的欄位</li>
    </ol>
  </div>

  <div>
    <button onclick="debugAdminProfile()">除錯 Admin 資料</button>
    <button onclick="debugMemberProfile()">除錯 Member 資料</button>
    <button onclick="clearAll()">清除資料</button>
  </div>

  <div id="result"></div>
  <div id="debugInfo"></div>

  <script type="module">
    const result = document.getElementById('result');
    const debugInfo = document.getElementById('debugInfo');
    
    let authStore = null;
    
    // 除錯 Admin 資料
    window.debugAdminProfile = async () => {
      try {
        // 清理
        localStorage.clear();
        sessionStorage.clear();
        result.innerHTML = '<div class="info">🔍 正在除錯 Admin 資料...</div>';
        debugInfo.innerHTML = '';
        
        // 手動呼叫登入 API 來查看完整回應
        result.innerHTML += '<div class="info">步驟 1: 手動呼叫登入 API...</div>';
        
        const loginResponse = await fetch('/koala/api/account/auth/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'pony@admin1.com',
            password: 'gAAAAABm2BKJQkywC7LdRRb4PBV8T7S3E_7-qEZWnhVhKdNrT3R2Hqf8OOpQ_GRwQKJmX0dn3m3t4gT8C7KvkZVDcXLwE2Hn_A=='
          })
        });
        
        if (!loginResponse.ok) {
          throw new Error(\`登入 API 失敗: \${loginResponse.status}\`);
        }
        
        const loginData = await loginResponse.json();
        console.log('完整登入回應:', loginData);
        
        let html = '<div class="data-section">';
        html += '<h4>🔍 完整登入 API 回應</h4>';
        html += \`<div class="code-block">\${JSON.stringify(loginData, null, 2)}</div>\`;
        html += '</div>';
        
        // 使用 auth store 登入
        result.innerHTML += '<div class="info">步驟 2: 使用 auth store 登入...</div>';
        
        const { useAuth } = await import('/src/stores/auth.ts');
        authStore = useAuth();
        await authStore.login('pony@admin1.com', '2m8N625cvmf0');
        
        // 檢查 localStorage 中的 profile
        const storedProfile = localStorage.getItem('penguin.user');
        const parsedProfile = storedProfile ? JSON.parse(storedProfile) : null;
        
        html += '<div class="data-section">';
        html += '<h4>💾 localStorage 中的 Profile</h4>';
        html += \`<div class="code-block">\${JSON.stringify(parsedProfile, null, 2)}</div>\`;
        html += '</div>';
        
        // 檢查 auth store 中的用戶
        html += '<div class="data-section">';
        html += '<h4>🏪 Auth Store 中的用戶資料</h4>';
        html += \`<div class="code-block">\${JSON.stringify(authStore.user, null, 2)}</div>\`;
        html += '</div>';
        
        // 分析缺失欄位
        html += '<div class="data-section">';
        html += '<h4>🔍 欄位分析</h4>';
        html += '<ul>';
        html += \`<li><strong>phone:</strong> API: \${loginData?.data?.profile?.phone || '無'}, Store: \${authStore.user?.phone || '無'}</li>\`;
        html += \`<li><strong>national_id:</strong> API: \${loginData?.data?.profile?.national_id || '無'}, Store: \${authStore.user?.idNumber || '無'}</li>\`;
        html += \`<li><strong>full_name:</strong> API: \${loginData?.data?.profile?.full_name || '無'}, Store: \${authStore.user?.name || '無'}</li>\`;
        html += '</ul>';
        html += '</div>';
        
        debugInfo.innerHTML = html;
        result.innerHTML += '<div class="success">✅ Admin 除錯完成</div>';
        
      } catch (err) {
        result.innerHTML += \`<div class="error">❌ Admin 除錯失敗：\${err.message}</div>\`;
        console.error('Admin debug error:', err);
      }
    };
    
    // 除錯 Member 資料  
    window.debugMemberProfile = async () => {
      try {
        // 清理
        localStorage.clear();
        sessionStorage.clear();
        result.innerHTML = '<div class="info">🔍 正在除錯 Member 資料...</div>';
        debugInfo.innerHTML = '';
        
        // 手動呼叫登入 API
        result.innerHTML += '<div class="info">步驟 1: 手動呼叫登入 API...</div>';
        
        const loginResponse = await fetch('/koala/api/account/auth/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'pony_member_real1',
            password: 'gAAAAABm2BKJQkywC7LdRRb4PBV8T7S3E_7-qEZWnhVhKdNrT3R2Hqf8OOpQ_GRwQKJmX0dn3m3t4gT8C7KvkZVDcXLwE2Hn_A=='
          })
        });
        
        if (!loginResponse.ok) {
          throw new Error(\`登入 API 失敗: \${loginResponse.status}\`);
        }
        
        const loginData = await loginResponse.json();
        console.log('完整登入回應:', loginData);
        
        let html = '<div class="data-section">';
        html += '<h4>🔍 完整登入 API 回應</h4>';
        html += \`<div class="code-block">\${JSON.stringify(loginData, null, 2)}</div>\`;
        html += '</div>';
        
        // 使用 auth store 登入
        result.innerHTML += '<div class="info">步驟 2: 使用 auth store 登入...</div>';
        
        const { useAuth } = await import('/src/stores/auth.ts');
        authStore = useAuth();
        await authStore.login('pony_member_real1', '2m8N625cvmf0');
        
        // 檢查 localStorage 中的 profile
        const storedProfile = localStorage.getItem('penguin.user');
        const parsedProfile = storedProfile ? JSON.parse(storedProfile) : null;
        
        html += '<div class="data-section">';
        html += '<h4>💾 localStorage 中的 Profile</h4>';
        html += \`<div class="code-block">\${JSON.stringify(parsedProfile, null, 2)}</div>\`;
        html += '</div>';
        
        // 檢查 auth store 中的用戶
        html += '<div class="data-section">';
        html += '<h4>🏪 Auth Store 中的用戶資料</h4>';
        html += \`<div class="code-block">\${JSON.stringify(authStore.user, null, 2)}</div>\`;
        html += '</div>';
        
        // 分析缺失欄位
        html += '<div class="data-section">';
        html += '<h4>🔍 欄位分析</h4>';
        html += '<ul>';
        html += \`<li><strong>phone:</strong> API: \${loginData?.data?.profile?.phone || '無'}, Store: \${authStore.user?.phone || '無'}</li>\`;
        html += \`<li><strong>national_id:</strong> API: \${loginData?.data?.profile?.national_id || '無'}, Store: \${authStore.user?.idNumber || '無'}</li>\`;
        html += \`<li><strong>full_name:</strong> API: \${loginData?.data?.profile?.full_name || '無'}, Store: \${authStore.user?.name || '無'}</li>\`;
        html += '</ul>';
        html += '</div>';
        
        debugInfo.innerHTML = html;
        result.innerHTML += '<div class="success">✅ Member 除錯完成</div>';
        
      } catch (err) {
        result.innerHTML += \`<div class="error">❌ Member 除錯失敗：\${err.message}</div>\`;
        console.error('Member debug error:', err);
      }
    };
    
    window.clearAll = () => {
      localStorage.clear();
      sessionStorage.clear();
      result.innerHTML = '';
      debugInfo.innerHTML = '';
      authStore = null;
    };
  </script>
</body>
</html>