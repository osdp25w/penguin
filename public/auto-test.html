<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è‡ªå‹•ç™»å…¥æ¸¬è©¦</title>
  <style>
    body { font-family: system-ui; padding: 20px; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .result { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .step { margin: 10px 0; padding: 10px; border-left: 3px solid #007bff; background: #f8f9fa; }
  </style>
</head>
<body>
  <h1>ğŸ¤– è‡ªå‹•ç™»å…¥ä¸¦æ¸¬è©¦ Member API</h1>
  <p>é€™å€‹æ¸¬è©¦æœƒè‡ªå‹•ä½¿ç”¨ auth store ç™»å…¥ä¸¦æª¢æŸ¥å€‹äººè³‡æ–™è³‡æ–™</p>
  <button id="testBtn">é–‹å§‹è‡ªå‹•æ¸¬è©¦</button>
  <div id="result" class="result"></div>

  <script type="module">
    document.getElementById('testBtn').addEventListener('click', async () => {
      const result = document.getElementById('result');
      result.innerHTML = '<div class="info">ğŸ”„ é–‹å§‹è‡ªå‹•æ¸¬è©¦æµç¨‹...</div>';
      
      try {
        let html = '';
        
        // æ­¥é©Ÿ 1: æ¸…ç†ä¸¦åˆå§‹åŒ– Pinia
        html += '<div class="step"><strong>æ­¥é©Ÿ 1:</strong> åˆå§‹åŒ– Pinia å’Œæ¸…ç†è³‡æ–™</div>';
        result.innerHTML = html;
        
        localStorage.clear();
        sessionStorage.clear();
        
        // åˆå§‹åŒ– Pinia
        const { createPinia } = await import('pinia');
        const { createApp } = await import('vue');
        
        const app = createApp({});
        const pinia = createPinia();
        app.use(pinia);
        
        // æ­¥é©Ÿ 2: ç™»å…¥
        html += '<div class="step"><strong>æ­¥é©Ÿ 2:</strong> ä½¿ç”¨ auth store ç™»å…¥ pony_member_real1</div>';
        result.innerHTML = html;
        
        const { useAuth } = await import('/src/stores/auth.ts');
        const authStore = useAuth();
        
        await authStore.login('pony_member_real1', '2m8N625cvmf0');
        console.log('ç™»å…¥æˆåŠŸï¼Œç”¨æˆ¶è³‡æ–™:', authStore.user);
        
        // æ­¥é©Ÿ 3: æª¢æŸ¥ç™»å…¥å¾Œçš„ç”¨æˆ¶è³‡æ–™
        html += '<div class="step"><strong>æ­¥é©Ÿ 3:</strong> æª¢æŸ¥ç™»å…¥å¾Œçš„ç”¨æˆ¶è³‡æ–™</div>';
        result.innerHTML = html;
        
        const user = authStore.user;
        console.log('ç”¨æˆ¶ phone:', user?.phone);
        console.log('ç”¨æˆ¶ idNumber:', user?.idNumber);
        
        // æ­¥é©Ÿ 4: ç›´æ¥èª¿ç”¨ Member API
        html += '<div class="step"><strong>æ­¥é©Ÿ 4:</strong> ç›´æ¥èª¿ç”¨ Member API</div>';
        result.innerHTML = html;
        
        const { Koala } = await import('/src/services/koala.ts');
        const memberId = user?.id || '1';
        
        console.log('èª¿ç”¨ getMember APIï¼ŒID:', memberId);
        const memberData = await Koala.getMember(memberId);
        console.log('Member API åŸå§‹å›æ‡‰:', memberData);
        
        const data = memberData?.data || memberData;
        console.log('è™•ç†å¾Œçš„è³‡æ–™:', data);
        
        // é¡¯ç¤ºæœ€çµ‚çµæœ
        html += '<div class="success"><h3>âœ… è‡ªå‹•æ¸¬è©¦å®Œæˆ</h3></div>';
        
        html += '<h4>ğŸ” ç™»å…¥å¾Œçš„ç”¨æˆ¶è³‡æ–™ï¼ˆauth storeï¼‰ï¼š</h4>';
        html += '<ul>';
        html += '<li><strong>id:</strong> ' + (user?.id || 'âŒ ç„¡') + '</li>';
        html += '<li><strong>name:</strong> ' + (user?.name || 'âŒ ç„¡') + '</li>';
        html += '<li><strong>email:</strong> ' + (user?.email || 'âŒ ç„¡') + '</li>';
        html += '<li><strong>phone:</strong> ' + (user?.phone || 'âŒ ç„¡') + '</li>';
        html += '<li><strong>idNumber:</strong> ' + (user?.idNumber || 'âŒ ç„¡') + '</li>';
        html += '<li><strong>roleId:</strong> ' + (user?.roleId || 'âŒ ç„¡') + '</li>';
        html += '</ul>';
        
        html += '<h4>ğŸ” Member API ç›´æ¥å›æ‡‰ï¼š</h4>';
        html += '<ul>';
        html += '<li><strong>phone:</strong> ' + (data?.phone || 'âŒ API ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>national_id:</strong> ' + (data?.national_id || 'âŒ API ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>full_name:</strong> ' + (data?.full_name || 'âŒ API ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>email:</strong> ' + (data?.email || 'âŒ API ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>username:</strong> ' + (data?.username || 'âŒ API ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '</ul>';
        
        // è¨ºæ–·å•é¡Œ
        html += '<h4>ğŸ©º å•é¡Œè¨ºæ–·ï¼š</h4>';
        html += '<ul>';
        
        const hasAuthPhone = user?.phone;
        const hasAuthIdNumber = user?.idNumber;
        const hasApiPhone = data?.phone;
        const hasApiNationalId = data?.national_id;
        
        if (!hasApiPhone && !hasApiNationalId) {
          html += '<li>âŒ <strong>æ ¹æœ¬åŸå› :</strong> API æ²’æœ‰è¿”å› phone å’Œ national_id æ¬„ä½</li>';
          html += '<li>ğŸ’¡ <strong>å¯èƒ½è§£æ±ºæ–¹æ¡ˆ:</strong> æª¢æŸ¥å¾Œç«¯è³‡æ–™åº«æˆ– API å¯¦ä½œ</li>';
        } else if (hasApiPhone && hasApiNationalId && !hasAuthPhone && !hasAuthIdNumber) {
          html += '<li>âŒ <strong>æ ¹æœ¬åŸå› :</strong> API æœ‰è³‡æ–™ä½† auth store è™•ç†é‚è¼¯æœ‰å•é¡Œ</li>';
          html += '<li>ğŸ’¡ <strong>å¯èƒ½è§£æ±ºæ–¹æ¡ˆ:</strong> ä¿®å¾© fetchFullUserProfile æˆ– login æ–¹æ³•</li>';
        } else if (hasAuthPhone && hasAuthIdNumber) {
          html += '<li>âœ… <strong>è³‡æ–™æ­£å¸¸:</strong> auth store ä¸­æœ‰é›»è©±å’Œèº«ä»½è­‰è™Ÿ</li>';
          html += '<li>ğŸ’¡ <strong>æª¢æŸ¥:</strong> å€‹äººè³‡æ–™æ¨¡æ…‹æ¡†çš„é¡¯ç¤ºé‚è¼¯</li>';
        }
        
        html += '</ul>';
        
        // é¡¯ç¤ºå®Œæ•´çš„ API å›æ‡‰ï¼ˆæ‘ºç–Šï¼‰
        html += '<details style="margin-top: 20px;"><summary><h4>ğŸ“„ å®Œæ•´ API å›æ‡‰ï¼ˆé»æ“Šå±•é–‹ï¼‰</h4></summary>';
        html += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto; max-height: 400px;">';
        html += JSON.stringify(memberData, null, 2);
        html += '</pre></details>';
        
        result.innerHTML = html;
        
      } catch (err) {
        console.error('è‡ªå‹•æ¸¬è©¦éŒ¯èª¤:', err);
        result.innerHTML += '<div class="error"><h3>âŒ è‡ªå‹•æ¸¬è©¦å¤±æ•—</h3><p>' + err.message + '</p><p>è«‹æŸ¥çœ‹æ§åˆ¶å°äº†è§£è©³ç´°éŒ¯èª¤</p></div>';
      }
    });
  </script>
</body>
</html>