<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æª¢æŸ¥ç¾æœ‰ç™»å…¥</title>
  <style>
    body { font-family: system-ui; padding: 20px; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .result { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
    .info { background: #d1ecf1; color: #0c5460; }
    .warning { background: #fff3cd; color: #856404; }
  </style>
</head>
<body>
  <h1>ğŸ” æª¢æŸ¥ç¾æœ‰ç™»å…¥ç‹€æ…‹</h1>
  <p><strong>æ­¥é©Ÿï¼š</strong></p>
  <ol>
    <li>è«‹å…ˆåœ¨ä¸»æ‡‰ç”¨ (https://localhost:5174/) ä¸­ç™»å…¥ pony_member_real1</li>
    <li>ç™»å…¥æˆåŠŸå¾Œï¼Œå›åˆ°é€™å€‹é é¢é»æ“Šä¸‹æ–¹æŒ‰éˆ•</li>
  </ol>
  
  <button id="checkBtn">æª¢æŸ¥ç¾æœ‰ç™»å…¥å’Œ API è³‡æ–™</button>
  <div id="result" class="result"></div>

  <script>
    document.getElementById('checkBtn').addEventListener('click', async () => {
      const result = document.getElementById('result');
      result.innerHTML = '<div class="info">ğŸ”„ æ­£åœ¨æª¢æŸ¥ç¾æœ‰ç™»å…¥...</div>';
      
      try {
        let html = '';
        
        // æª¢æŸ¥ localStorage ä¸­çš„è³‡æ–™
        const token = localStorage.getItem('penguin.jwt');
        const storedProfile = localStorage.getItem('penguin.user');
        
        if (!token) {
          result.innerHTML = '<div class="warning"><h3>âš ï¸ æœªæ‰¾åˆ°ç™»å…¥ Token</h3><p>è«‹å…ˆåœ¨ä¸»æ‡‰ç”¨ä¸­ç™»å…¥ pony_member_real1</p></div>';
          return;
        }
        
        console.log('æ‰¾åˆ° token:', token.substring(0, 30) + '...');
        
        // è§£æå­˜å„²çš„ profile
        let profile = null;
        if (storedProfile) {
          try {
            profile = JSON.parse(storedProfile);
            console.log('å­˜å„²çš„ profile:', profile);
          } catch (e) {
            console.error('è§£æ profile å¤±æ•—:', e);
          }
        }
        
        // ä½¿ç”¨ç¾æœ‰ token èª¿ç”¨ Member API
        const memberId = profile?.id || profile?.user_id || '1';
        console.log('ä½¿ç”¨ Member ID:', memberId);
        
        const memberRes = await fetch('/koala/api/account/members/' + memberId + '/', {
          method: 'GET',
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json' 
          }
        });
        
        console.log('Member API ç‹€æ…‹:', memberRes.status);
        
        if (!memberRes.ok) {
          const errorText = await memberRes.text();
          throw new Error('Member API èª¿ç”¨å¤±æ•— (' + memberRes.status + '): ' + errorText);
        }
        
        const memberData = await memberRes.json();
        console.log('Member API å®Œæ•´å›æ‡‰:', memberData);
        
        const memberInfo = memberData.data || memberData;
        console.log('è™•ç†å¾Œçš„ Member è³‡æ–™:', memberInfo);
        
        // é¡¯ç¤ºçµæœ
        html += '<div class="success"><h3>âœ… æˆåŠŸç²å–è³‡æ–™</h3></div>';
        
        // åˆ†æå­˜å„²çš„ Profile
        html += '<h4>ğŸ’¾ localStorage ä¸­çš„ Profileï¼š</h4>';
        if (profile) {
          html += '<ul>';
          html += '<li><strong>id:</strong> ' + (profile.id || profile.user_id || 'âŒ ç„¡') + '</li>';
          html += '<li><strong>username:</strong> ' + (profile.username || 'âŒ ç„¡') + '</li>';
          html += '<li><strong>full_name:</strong> ' + (profile.full_name || 'âŒ ç„¡') + '</li>';
          html += '<li><strong>email:</strong> ' + (profile.email || 'âŒ ç„¡') + '</li>';
          html += '<li><strong>phone:</strong> ' + (profile.phone || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
          html += '<li><strong>national_id:</strong> ' + (profile.national_id || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
          html += '</ul>';
        } else {
          html += '<p>âŒ æ²’æœ‰å­˜å„²çš„ profile è³‡æ–™</p>';
        }
        
        // åˆ†æ Member API è³‡æ–™
        html += '<h4>ğŸ” Member API å›æ‡‰åˆ†æï¼š</h4>';
        html += '<ul>';
        html += '<li><strong>API ç‹€æ…‹:</strong> ' + memberRes.status + ' (æˆåŠŸ)</li>';
        html += '<li><strong>å›æ‡‰çµæ§‹:</strong> ' + (memberData.data ? 'data åŒ…è£' : 'ç›´æ¥å›æ‡‰') + '</li>';
        html += '<li><strong>phone:</strong> ' + (memberInfo?.phone || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>national_id:</strong> ' + (memberInfo?.national_id || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>full_name:</strong> ' + (memberInfo?.full_name || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>email:</strong> ' + (memberInfo?.email || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>username:</strong> ' + (memberInfo?.username || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '<li><strong>type:</strong> ' + (memberInfo?.type || 'âŒ ç„¡æ­¤æ¬„ä½') + '</li>';
        html += '</ul>';
        
        // é—œéµè¨ºæ–·
        html += '<h4>ğŸ©º é—œéµè¨ºæ–·ï¼š</h4>';
        const profileHasPhone = profile?.phone;
        const profileHasNationalId = profile?.national_id;
        const apiHasPhone = memberInfo?.phone;
        const apiHasNationalId = memberInfo?.national_id;
        
        html += '<ul>';
        if (!apiHasPhone && !apiHasNationalId) {
          html += '<li>âŒ <strong>æ ¹æœ¬å•é¡Œ:</strong> Member API æ²’æœ‰è¿”å› phone å’Œ national_id æ¬„ä½</li>';
          html += '<li>ğŸ’¡ <strong>åŸå› :</strong> å¯èƒ½æ˜¯å¾Œç«¯è³‡æ–™åº«æ²’æœ‰é€™äº›è³‡æ–™ï¼Œæˆ– API åºåˆ—åŒ–å™¨æ²’æœ‰åŒ…å«é€™äº›æ¬„ä½</li>';
          html += '<li>ğŸ”§ <strong>è§£æ±ºæ–¹æ¡ˆ:</strong> éœ€è¦æª¢æŸ¥å¾Œç«¯å¯¦ä½œå’Œè³‡æ–™åº«å…§å®¹</li>';
        } else if (apiHasPhone && apiHasNationalId) {
          html += '<li>âœ… <strong>API è³‡æ–™æ­£å¸¸:</strong> Member API æœ‰è¿”å› phone å’Œ national_id</li>';
          if (!profileHasPhone || !profileHasNationalId) {
            html += '<li>âš ï¸ <strong>å‰ç«¯è™•ç†å•é¡Œ:</strong> API æœ‰è³‡æ–™ä½†ç™»å…¥æ™‚æ²’æœ‰æ­£ç¢ºä¿å­˜</li>';
            html += '<li>ğŸ”§ <strong>è§£æ±ºæ–¹æ¡ˆ:</strong> æª¢æŸ¥ auth store çš„ login å’Œ fetchFullUserProfile æ–¹æ³•</li>';
          } else {
            html += '<li>âœ… <strong>è³‡æ–™å®Œæ•´:</strong> API å’Œæœ¬åœ°éƒ½æœ‰è³‡æ–™ï¼Œå•é¡Œå¯èƒ½åœ¨å€‹äººè³‡æ–™æ¨¡æ…‹æ¡†</li>';
            html += '<li>ğŸ”§ <strong>è§£æ±ºæ–¹æ¡ˆ:</strong> æª¢æŸ¥ EditProfileModal.vue çš„è³‡æ–™ç¶å®š</li>';
          }
        } else {
          html += '<li>âš ï¸ <strong>éƒ¨åˆ†è³‡æ–™:</strong> åªæœ‰éƒ¨åˆ†æ¬„ä½æœ‰è³‡æ–™</li>';
          if (apiHasPhone && !apiHasNationalId) {
            html += '<li>ğŸ’¡ phone æœ‰è³‡æ–™ä½† national_id æ²’æœ‰</li>';
          }
          if (!apiHasPhone && apiHasNationalId) {
            html += '<li>ğŸ’¡ national_id æœ‰è³‡æ–™ä½† phone æ²’æœ‰</li>';
          }
        }
        html += '</ul>';
        
        // é¡¯ç¤ºåŸå§‹è³‡æ–™
        html += '<details style="margin-top: 20px;"><summary><h4>ğŸ“„ åŸå§‹ localStorage Profile</h4></summary>';
        html += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto;">';
        html += JSON.stringify(profile, null, 2);
        html += '</pre></details>';
        
        html += '<details><summary><h4>ğŸ“„ åŸå§‹ Member API å›æ‡‰</h4></summary>';
        html += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto; max-height: 400px;">';
        html += JSON.stringify(memberData, null, 2);
        html += '</pre></details>';
        
        result.innerHTML = html;
        
      } catch (err) {
        console.error('æª¢æŸ¥éŒ¯èª¤:', err);
        result.innerHTML += '<div class="error"><h3>âŒ æª¢æŸ¥å¤±æ•—</h3><p>' + err.message + '</p></div>';
      }
    });
  </script>
</body>
</html>