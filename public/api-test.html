<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>API 測試</title>
  <style>
    body { font-family: system-ui; padding: 20px; }
    button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .result { margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 5px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>直接 API 測試</h1>
  <button id="testBtn">執行 Member API 測試</button>
  <div id="result" class="result"></div>

  <script>
    document.getElementById('testBtn').addEventListener('click', async () => {
      const result = document.getElementById('result');
      result.innerHTML = '正在執行測試...';
      
      try {
        // 先加密密碼
        console.log('開始加密密碼...');
        const encryptRes = await fetch('/local/fernet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            text: '2m8N625cvmf0'
          })
        });
        const encryptData = await encryptRes.json();
        const encryptedPassword = encryptData.token;
        console.log('加密後密碼:', encryptedPassword);
        
        // 先登入
        console.log('開始登入...');
        const loginRes = await fetch('/koala/api/account/auth/login/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: 'pony_member_real1',
            password: encryptedPassword
          })
        });
        const loginData = await loginRes.json();
        console.log('登入回應:', loginData);
        
        if (!loginData.data?.tokens?.access_token) {
          throw new Error('登入失敗: ' + JSON.stringify(loginData));
        }
        
        const token = loginData.data.tokens.access_token;
        console.log('取得 token:', token.substring(0, 20) + '...');
        
        // 調用 Member API
        console.log('呼叫 Member API...');
        const memberRes = await fetch('/koala/api/account/members/1/', {
          method: 'GET',
          headers: { 
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json' 
          }
        });
        
        console.log('Member API 狀態:', memberRes.status);
        const memberData = await memberRes.json();
        console.log('Member API 完整回應:', memberData);
        
        const data = memberData.data || memberData;
        console.log('實際資料:', data);
        console.log('phone:', data?.phone);
        console.log('national_id:', data?.national_id);
        console.log('full_name:', data?.full_name);
        
        // 顯示結果
        let html = '<div class="success"><h3>✅ API 測試成功</h3></div>';
        html += '<h4>關鍵欄位檢查結果：</h4>';
        html += '<ul>';
        html += '<li><strong>phone:</strong> ' + (data?.phone || '❌ 無此欄位') + '</li>';
        html += '<li><strong>national_id:</strong> ' + (data?.national_id || '❌ 無此欄位') + '</li>';
        html += '<li><strong>full_name:</strong> ' + (data?.full_name || '❌ 無此欄位') + '</li>';
        html += '<li><strong>email:</strong> ' + (data?.email || '❌ 無此欄位') + '</li>';
        html += '<li><strong>username:</strong> ' + (data?.username || '❌ 無此欄位') + '</li>';
        html += '</ul>';
        
        html += '<h4>完整 API 回應結構：</h4>';
        html += '<pre style="background: white; padding: 10px; border: 1px solid #ddd; overflow-x: auto;">';
        html += JSON.stringify(memberData, null, 2);
        html += '</pre>';
        
        result.innerHTML = html;
        
      } catch (err) {
        console.error('API 測試錯誤:', err);
        result.innerHTML = '<div class="error"><h3>❌ API 測試失敗</h3><p>' + err.message + '</p></div>';
      }
    });
  </script>
</body>
</html>